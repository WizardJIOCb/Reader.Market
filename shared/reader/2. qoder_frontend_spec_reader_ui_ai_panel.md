# Frontend ТЗ для Qoder: Модуль чтения (React) + ИИ-панель

## 1) Цель UX
Пользователь должен:
1) выбрать книгу → открыть чтение
2) продолжить с последнего места
3) быстро создавать закладки/хайлайты/заметки
4) получать ИИ-помощь по месту/выделению
5) возвращаться к сохранённым местам
6) всегда понимать контекст: текущая глава + прогресс

---

## 2) Пользовательский путь (User Journey)

### 2.1 Открытие книги
- Клик по книге в библиотеке/полке → `/read/:bookId`.
- Показать skeleton/loader.
- Запросить: `manifest`, `progress`, `annotations`.
- Если есть сохранённая позиция — **автопереход к ней**.
- Если нет — открыть начало книги / первую главу.

### 2.2 Чтение
- Скролл/перелистывание.
- Прогресс (процент) обновляется в UI.
- Сохранение прогресса на backend — **debounce**.

### 2.3 Выделение текста
- Выделение → появляется **Floating Selection Toolbar** рядом с выделением.
- Действия: Highlight, Note, Ask AI, Explain, Copy.

### 2.4 ИИ-помощник
- Открывается правой панелью (Drawer/Side panel).
- Быстрые действия:
  - Summarize chapter
  - Help around here
  - Spoiler after here: safe/soft/full
- Ответ — как чат (желательно со стримингом во 2 фазе).

### 2.5 Навигация
- Оглавление (TOC) слева.
- Списки закладок/хайлайтов/заметок справа.
- Клик по элементу → `goTo(location)`.

---

## 3) Роуты и страницы

### 3.1 `/read/:bookId` — ReaderPage
**Основной экран чтения.**

Layout (desktop):
- TopBar (fixed)
- LeftDrawer: TOC / Search
- Center: ReaderViewport
- RightDrawer: AI / Annotations (tabs)

Layout (mobile):
- TopBar
- ReaderViewport
- Drawers как bottom-sheet/fullscreen

---

## 4) UI элементы и поведение

## 4.1 TopBar (fixed)
Состав:
- Back (в библиотеку)
- Название книги (сокращённое)
- Текущая глава
- Прогресс: “37%” + тонкая progress bar
- Иконки:
  - TOC
  - Search (опционально, MVP2)
  - Notes/Bookmarks
  - AI
  - Settings

Поведение:
- Прогресс обновляется в реальном времени.
- Запись прогресса — debounce.
- Клик по названию главы открывает быстрый список глав.

---

## 4.2 ReaderViewport (центр)
Контейнер для `ReaderAdapter.mount(container)`.

Поведение:
- Поддержка `scrolled` и `paginated` режимов (если доступно).
- Подсветки (highlights) отображаются в тексте.
- Маркеры заметок (underline/иконка) — по `LocationRange`.
- Выделение текста вызывает Selection Toolbar.

Состояния:
- Loading skeleton
- Error card + кнопка Reload

---

## 4.3 Floating Selection Toolbar
Появляется рядом с выделением.

Кнопки:
- Highlight
- Note
- Ask AI (QA)
- Explain
- Copy

Поведение:
- Highlight → создать annotation, сразу отрендерить.
- Note → Dialog для ввода текста, затем сохранить.
- Ask AI/Explain → открыть AI panel и отправить запрос.

Mobile:
- вместо floating — bottom sheet с действиями.

---

## 4.4 Left Drawer: TOC / Search
Tabs:
- TOC
- Search (опционально MVP2)

TOC:
- дерево (Accordion/Collapsible)
- активный пункт подсвечен
- клик → `goTo(location)`

Search (если есть):
- input
- результаты с snippet
- клик → `goTo(location)`

---

## 4.5 Right Drawer: AI / Annotations
Tabs:
- AI
- Notes
- Highlights
- Bookmarks

### AI tab
Quick Actions:
- Summarize this chapter
- Help around here
- Spoiler after here: Safe / Soft / Full

Chat:
- сообщения пользователя (action)
- сообщения ИИ
- кнопки: Copy, Pin to note (опц)

Если backend возвращает citations:
- показывать “Cited from text” → клик прыгает к `LocationRange`.

### Notes/Highlights/Bookmarks tabs
Каждый элемент:
- quote/snippet
- дата
- (для note) текст заметки
- кнопки: GoTo, Edit, Delete

---

## 4.6 Settings (Dialog/Drawer)
- Theme: light/dark/sepia
- Font size slider
- Font family select (опционально)
- Line height slider (опционально)
- Reading mode: scrolled/paginated (если доступно)

Сохранение:
- localStorage
- применение через `adapter.setSettings()`

---

## 5) Библиотеки (использовать)

- Routing: **Wouter**
- Data/cache: **@tanstack/react-query**
- UI primitives: **Radix UI** (Dialog, Tabs, Accordion, Dropdown, Tooltip, Drawer/Sheet)
- Styling: **Tailwind CSS**

Reader engine:
- EPUB (MVP): **react-reader + epub.js** (или epub.js напрямую, если нужно больше контроля)
- HTML (конвертированные форматы): собственный `HtmlAdapter` (рендер sanitized HTML)
- PDF (опционально): PDF.js / react-pdf (read-only)

---

## 6) Реализация и структура кода

Рекомендуемая структура:
```
client/src/features/reader/
  ReaderPage.tsx
  components/
    TopBar.tsx
    ReaderViewport.tsx
    TocDrawer.tsx
    RightDrawer.tsx
    AiPanel.tsx
    AnnotationList.tsx
    SelectionToolbar.tsx
    SettingsDialog.tsx
  adapters/
    ReaderAdapter.ts
    EpubAdapter.ts
    HtmlAdapter.ts
    PdfAdapter.ts (optional)
  hooks/
    useReaderController.ts
    useReaderProgress.ts
    useAnnotations.ts
    useAiAssist.ts
```

---

## 7) UX/инженерные детали (важно)

### 7.1 Автосохранение прогресса
- Debounce 1–3 сек.
- Best effort save на `beforeunload`.

### 7.2 Восстановление позиции
- После загрузки книги показать toast: “Continuing from last position…”.

### 7.3 Ошибки
- Ошибка движка → error card + Reload.
- AI недоступен → AI panel показывает “AI service unavailable”.

### 7.4 Адаптив
- Mobile: Drawers как fullscreen/bottom-sheet.
- Selection actions: bottom-sheet.

---

## 8) Definition of Done (Frontend)

1) `/read/:bookId` открывает книгу, восстанавливает позицию.
2) Selection toolbar появляется и работает.
3) Bookmark/Highlight/Note создаются, сохраняются и отображаются.
4) AI panel работает по:
   - выделению
   - текущему месту
   - главе
5) TOC работает и позволяет переходить.
6) Settings применяются и сохраняются.

---

Примечание: AI запросы всегда идут через backend, frontend не вызывает Ollama напрямую.

