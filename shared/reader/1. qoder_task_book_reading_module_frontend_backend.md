# Задача для Qoder

## Проект
**Reader.Market** — веб‑приложение для чтения загруженных пользователем книг с ИИ‑помощником.

Стек проекта:
- Frontend: **React 19**, TypeScript, TanStack Query, Wouter, Tailwind, Radix
- Backend: **Node.js + Express**, TypeScript
- DB: **PostgreSQL + Drizzle ORM**
- AI: **Ollama (локальные LLM)**

Форматы книг:
- Основные: **EPUB, DOC, DOCX, FB2, TXT**
- PDF — опционально (read‑only, не MVP)

Ключевая ценность продукта — **ИИ‑чтение**:
- помощь по контексту
- объяснение выделений
- суммаризация глав
- спойлеры после конкретного места
- закладки, заметки, хайлайты, привязанные к точной позиции в книге

---

## 1. Цель задачи
Реализовать **модуль чтения книг (frontend + backend)**, который:
1. Поддерживает чтение книг в браузере
2. Имеет стабильные закладки/заметки/хайлайты
3. Позволяет ИИ работать **с конкретным местом текста**, а не страницами
4. Масштабируем под новые форматы и движки чтения

---

## 2. Ключевая архитектурная идея (ОБЯЗАТЕЛЬНО)

### 2.1 Единый идентификатор позиции — Location

Все действия пользователя и ИИ должны ссылаться **не на страницу**, а на логическую позицию:

- EPUB → `epub-cfi`
- HTML (DOC/DOCX/FB2/TXT после конвертации) → `dom-point`
- PDF (опционально) → `pdf-fragment`

```ts
Location = {
  type: "epub-cfi" | "dom-point" | "pdf-fragment",
  value: {...}
}
```

Закладки, заметки, хайлайты, цитаты ИИ **всегда** хранят Location / LocationRange.

---

### 2.2 Нормализация форматов (кроме EPUB)

DOC / DOCX / FB2 / TXT **обязательно** конвертируются в `normalized HTML`:

Требования к HTML:
- главы: `<section data-chapter-id="c1" id="ch_c1">`
- параграфы: `<p id="p_c1_000123" data-p-index="123">`
- id должны быть **стабильны** между сессиями

Это критично для якорей и ИИ.

---

## 3. Frontend (React)

### 3.1 Reader Adapter слой

Нужно реализовать абстракцию **ReaderAdapter** и конкретные адаптеры:

- `EpubAdapter` (приоритет №1)
- `HtmlAdapter` (для DOC/DOCX/FB2/TXT)
- `PdfAdapter` (опционально, read‑only)

Adapter отвечает за:
- рендер книги
- навигацию
- получение текущей позиции
- выделение текста
- извлечение текста для ИИ

---

### 3.2 Обязательные возможности Reader UI

- открыть книгу `/read/:bookId`
- восстановить последнюю позицию
- навигация (скролл / страницы)
- настройки: тема, размер шрифта
- выделение текста
- создание:
  - bookmark (на текущем месте)
  - highlight (по выделению)
  - note (по выделению)
- список аннотаций → клик → переход в место

---

### 3.3 ИИ‑панель (UI)

Отдельная панель / drawer:

- Суммаризация текущей главы
- Объяснить выделение
- Вопрос по выделению (QA)
- Контекст вокруг текущего места
- Спойлер после текущего места:
  - safe / soft / full

Ответ ИИ:
- отображается текст
- (желательно) цитаты с привязкой к LocationRange

Frontend **не обращается напрямую к Ollama**.

---

## 4. Backend (Node.js + Express)

### 4.1 Хранение производных данных книги

При загрузке книги должны генерироваться:

```
/uploads/<user>/<bookId>/
  ├─ original.ext
  └─ derived/
      ├─ normalized.html   (для docx/fb2/txt)
      ├─ toc.json
      ├─ chapters.json
      └─ text_map.json
```

`text_map.json` используется для ИИ и содержит текст по главам и блокам.

---

### 4.2 API (минимум)

#### Reader
- `GET /api/reader/books/:bookId/manifest`
- `GET /api/reader/books/:bookId/chapters/:chapterId`
- `GET /api/reader/books/:bookId/progress`
- `POST /api/reader/books/:bookId/progress`

#### Annotations
- `GET /api/reader/books/:bookId/annotations`
- `POST /api/reader/books/:bookId/annotations`
- `PATCH /api/reader/books/:bookId/annotations/:id`
- `DELETE /api/reader/books/:bookId/annotations/:id`

#### AI
- `POST /api/ai/run`
- (опционально) streaming endpoint (SSE)

---

### 4.3 ИИ‑слой

Backend:
- собирает текст (глава / контекст / выделение)
- формирует prompt
- вызывает Ollama
- возвращает результат

ИИ‑фичи:
- summarizeChapter (обязательно кешировать)
- explainSelection
- qaSelection
- contextAroundLocation
- spoilerAfterLocation (safe/soft/full)

---

### 4.4 Кеш ИИ

Таблица `ai_cache`:
- bookId
- userId
- feature
- key (hash параметров)
- response
- createdAt

---

## 5. База данных

### 5.1 reading_progress
- userId
- bookId
- position (JSONB, Location)

### 5.2 annotations (новая таблица)
- id
- userId
- bookId
- type: bookmark | highlight | note
- location / range (JSONB)
- quote
- payload (note, label, color, tags)
- createdAt, updatedAt

---

## 6. Этапы реализации
- EPUB + HTML Reader
- Прогресс чтения
- Закладки, хайлайты, заметки
- ИИ: summarizeChapter, explainSelection, contextAround
- Спойлеры after location
- Streaming ответов ИИ
- Поиск по книге

---

## 7. Acceptance Criteria

- Книга открывается и восстанавливает позицию
- Аннотации сохраняются и ведут в правильное место
- ИИ корректно работает с выделением и текущей позицией
- Суммаризация главы кешируется
- Пользователь не имеет доступа к чужим книгам

---

## 8. Deliverables от Qoder

- Реализация ReaderAdapter + UI
- Backend API для reader / annotations / AI
- Конвертация форматов → normalized HTML
- Миграции Drizzle
- Документация по добавлению нового формата

---

❗ Важно: архитектура должна позволять **заменить движок чтения**, не переписывая ИИ‑логику.

